<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mathematical Induction | Mathswell</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
    <link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            startup: {
                ready: () => {
                    window.MathJax.startup.defaultReady();
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        :root {
            --primary-color: #0f766e;
            --primary-light: #10b981;
            --background: #f7faf9;
            --accent-amber: #f59e0b;
            --accent-red: #c62828;
            --text-primary: #212121;
            --text-muted: #4b5563;
            --container-bg: #ffffff;
            --border-color: #e5e7eb;
            --interactive-bg: #e6fffb;
            --success-color: #10b981;
            --error-color: #ef4444;
        }

        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--background);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--container-bg);
            min-height: 100vh;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        /* Mathswell Navigation */
        .mathswell-nav {
            display: flex;
            justify-content: center;
            margin: .4rem 0 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .mathswell-nav .mw-link {
            display: inline-flex;
            align-items: center;
            gap: .45rem;
            text-decoration: none;
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary-color);
            padding: .3rem .7rem;
            border-radius: 999px;
            background: rgba(255,255,255,.9);
            box-shadow: 0 1px 4px rgba(0,0,0,.08);
        }
        
        .mathswell-nav .mw-link img {
            display: block;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 2rem 2rem 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--container-bg);
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
        }

        .tab-button {
            flex: 1;
            min-width: 150px;
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            font-size: 1rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .tab-button:hover:not(.active) {
            background: var(--interactive-bg);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 2rem;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Introduction Styles */
        .intro-section {
            max-width: 800px;
            margin: 0 auto 3rem;
        }

        .concept-explanation {
            background: var(--interactive-bg);
            border-left: 4px solid var(--primary-color);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .concept-explanation h3 {
            color: var(--primary-color);
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }

        /* Domino Visualization */
        .domino-chain {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .domino {
            width: 100px;
            height: 110px;
            background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            padding: 0.4rem;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            position: relative;
            transform-origin: bottom center;
            line-height: 1.3;
        }

        .domino:hover {
            transform: translateY(-3px);
            box-shadow: 4px 4px 8px rgba(0,0,0,0.15);
        }

        .domino.falling {
            animation: dominoFall 0.4s ease-out forwards;
        }

        @keyframes dominoFall {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(30deg) translateX(10px);
                background: linear-gradient(145deg, #10b981, #059669);
                border-color: var(--success-color);
                color: white;
            }
        }

        /* Card Visualization */
        .card-chain {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .card {
            width: 110px;
            height: 120px;
            background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            padding: 0.3rem;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            position: relative;
            line-height: 1.2;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 4px 4px 8px rgba(0,0,0,0.15);
        }

        .card.error {
            background: linear-gradient(145deg, #ff6b6b, #ef4444);
            border-color: var(--error-color);
            color: white;
            animation: turnRed 0.4s ease;
        }

        @keyframes turnRed {
            from {
                background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
                transform: scale(1);
            }
            50% {
                transform: scale(1.1) rotate(-2deg);
            }
            to {
                background: linear-gradient(145deg, #ff6b6b, #ef4444);
                transform: scale(1);
            }
        }

        /* Card Containers */
        .infinite-dominos {
            background: var(--container-bg);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
            overflow: hidden;
        }

        .infinite-dominos h4 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }

        .property-box {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: var(--interactive-bg);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            text-align: left;
        }

        .property-box h5 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .property-step {
            margin: 0.8rem 0;
            padding: 0.8rem;
            background: white;
            border-radius: 6px;
            border-left: 3px solid var(--primary-light);
        }

        /* Formal Structure */
        .formal-intro {
            background: var(--container-bg);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .formal-intro h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .induction-components {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        @media (max-width: 768px) {
            .induction-components {
                grid-template-columns: 1fr;
            }
        }

        .component-box {
            background: var(--background);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .component-box.base-case {
            border-left: 6px solid var(--success-color);
        }

        .component-box.inductive-step {
            border-left: 6px solid var(--primary-color);
        }

        .component-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.8rem;
        }

        /* Example Toggle */
        .example-toggle {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
        }

        .toggle-btn {
            padding: 0.8rem 1.5rem;
            background: var(--background);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .toggle-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .toggle-btn:hover:not(.active) {
            border-color: var(--primary-color);
            background: var(--interactive-bg);
        }

        .example-card {
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .example-card h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .proof-display {
            background: var(--interactive-bg);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .proof-step {
            margin-bottom: 0.8rem;
            padding: 0.5rem 0;
            border-left: 3px solid transparent;
            padding-left: 0.8rem;
        }

        .proof-step.base {
            border-left-color: var(--success-color);
        }

        .proof-step.inductive {
            border-left-color: var(--primary-color);
        }

        /* Tree Visualization */
        .tree-visual {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 1.5rem 0;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .tree-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .tree-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .tree-svg {
            width: 150px;
            height: 120px;
        }

        .tree-vertex-small {
            stroke: var(--text-primary);
            stroke-width: 1.5;
        }

        .tree-vertex-small.red {
            fill: #ff6b6b !important;
        }

        .tree-vertex-small.blue {
            fill: #4dabf7 !important;
        }

        .tree-edge {
            stroke: var(--text-primary);
            stroke-width: 2;
        }

        /* AI Practice Section */
        .practice-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--background);
            border-radius: 12px;
        }

        @media (max-width: 768px) {
            .practice-controls {
                grid-template-columns: 1fr;
            }
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .control-group select {
            padding: 0.8rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: white;
            font-size: 1rem;
        }

        .control-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .generate-btn {
            grid-column: 1 / -1;
            padding: 1rem 2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            justify-self: center;
            max-width: 300px;
        }

        .generate-btn:hover:not(:disabled) {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .generate-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }

        /* Current Problem Display */
        .current-problem {
            background: var(--interactive-bg);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .current-problem h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .statement {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
        }

        /* Base Case Practice */
        .base-case-practice {
            background: var(--container-bg);
            border: 2px solid var(--success-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .base-case-practice h5 {
            color: var(--success-color);
            margin-bottom: 1rem;
        }

        .base-case-input {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .base-case-input input {
            padding: 0.8rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            width: 200px;
        }

        .base-case-input input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .base-case-input button {
            padding: 0.8rem 1.5rem;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .base-case-input button:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        /* Proof Construction */
        .proof-structure {
            max-width: 700px;
            margin: 0 auto;
        }

        .proof-box {
            background: var(--container-bg);
            border: 3px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .proof-box.base-box {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
        }

        .proof-box.if-then-container {
            border-color: var(--primary-color);
            background: rgba(15, 118, 110, 0.05);
        }

        .proof-box.steps-container {
            border-color: var(--border-color);
            background: var(--background);
        }

        .if-then-label {
            text-align: center;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .if-then-boxes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .if-then-boxes {
                grid-template-columns: 1fr;
            }
        }

        .if-box, .then-box {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            min-height: 80px;
        }

        .if-box {
            border-left: 4px solid var(--accent-amber);
        }

        .then-box {
            border-left: 4px solid var(--primary-light);
        }

        .box-label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .statement-display {
            font-size: 1.1rem;
            color: var(--text-primary);
            padding: 0.5rem;
            background: var(--interactive-bg);
            border-radius: 6px;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sortable-container {
            min-height: 200px;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 2px dashed var(--border-color);
        }

        .proof-step-item {
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            border-left: 5px solid var(--primary-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
        }

        .proof-step-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .proof-step-item:active {
            cursor: grabbing;
        }

        .proof-step-item.dragging {
            opacity: 0.5;
        }

        .proof-step-item.correct-position {
            border-left-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
        }

        /* Complete Proof Animation */
        .complete-proof {
            background: linear-gradient(135deg, #fff, var(--interactive-bg));
            border: 3px solid var(--primary-color);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 8px 32px rgba(15, 118, 110, 0.15);
            animation: mergeAnimation 0.8s ease;
            position: relative;
            overflow: hidden;
        }

        .complete-proof::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%);
            animation: shimmer 2s ease-out;
        }

        @keyframes mergeAnimation {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes shimmer {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .complete-proof h5 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 1.3rem;
            position: relative;
            z-index: 1;
        }

        .complete-proof-content {
            position: relative;
            z-index: 1;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .complete-proof-content p {
            margin-bottom: 1rem;
            line-height: 1.8;
        }

        .complete-proof-content strong {
            color: var(--primary-color);
            display: block;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .complete-proof-content .qed {
            text-align: right;
            font-size: 1.2rem;
            margin-top: 1rem;
            color: var(--primary-color);
        }

        /* Proof Controls */
        .proof-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
        }

        .proof-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .proof-btn.check {
            background: var(--primary-color);
            color: white;
        }

        .proof-btn.check:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .proof-btn.hint {
            background: var(--accent-amber);
            color: white;
        }

        .proof-btn.hint:hover {
            background: #dc8e0a;
            transform: translateY(-2px);
        }

        .proof-btn.reset {
            background: var(--accent-red);
            color: white;
        }

        .proof-btn.reset:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        /* Feedback Display */
        .feedback-display {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .feedback-display.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        .feedback-display.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            border: 2px solid var(--error-color);
        }

        .feedback-display.info {
            background: var(--interactive-bg);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .nav-btn {
            padding: 0.8rem 2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        /* Key Insights */
        .key-insights {
            background: var(--container-bg);
            border: 2px solid var(--accent-amber);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .key-insights h4 {
            color: var(--accent-amber);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .insight-item {
            margin-bottom: 1rem;
            padding-left: 1rem;
            border-left: 3px solid var(--accent-amber);
        }

        .insight-item:last-child {
            margin-bottom: 0;
        }

        .insight-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.3rem;
        }

        /* Warning Notice */
        .warning-notice {
            background: rgba(251, 191, 36, 0.1);
            color: #92400e;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            border-left: 3px solid var(--accent-amber);
            animation: fadeIn 0.5s ease;
        }

        /* Math content spacing */
        .mjx-chtml {
            margin: 0.2em 0 !important;
        }

        /* MathPal animations */
        @keyframes thinking {
            0%, 80%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            40% {
                transform: scale(1.5);
                opacity: 0.5;
            }
        }

        .robot-eye {
            animation: robot-blink 5s infinite;
        }

        @keyframes robot-blink {
            0%, 90%, 100% { opacity: 1; }
            95% { opacity: 0.1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="mathswell-nav">
            <a href="https://mathswell.com" class="mw-link">
                <img src="/logo-mathswell-square-mirror.svg" alt="Mathswell" width="28" height="28">
                <span>MATHSWELL</span>
            </a>
        </div>

        <div class="header">
            <h1>Mathematical Induction</h1>
            <p class="subtitle">Discover why both base case and inductive step are essential through interactive exploration</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" data-tab="introduction">Introduction</button>
            <button class="tab-button" data-tab="formal">Formal Structure</button>
            <button class="tab-button" data-tab="practice">AI Practice</button>
        </div>

        <div id="introduction" class="tab-content active">
            <div class="intro-section">
                <div class="concept-explanation">
                    <h3>What is Mathematical Induction?</h3>
                    <p>Mathematical induction proves statements about infinite sets of numbers by showing two things: the statement is true for the first case, and if it's true for any number, it must be true for the next number. You've been using this reasoning naturally your whole mathematical life - when you extend patterns from small numbers to larger ones.</p>
                </div>

                <div class="infinite-dominos">
                    <h4>Multiplication Property: Building on the Foundation</h4>
                    <p>Click the first domino to see how the pattern extends naturally:</p>
                    
                    <div class="domino-chain" id="multiplication-dominos">
                        <div class="domino" data-n="1" onclick="animateDominos()">
                            $\sqrt{ab}$<br>=<br>$\sqrt{a}\sqrt{b}$
                        </div>
                        <div class="domino" data-n="2">
                            $\sqrt{abc}$<br>=<br>$\sqrt{a}\sqrt{b}\sqrt{c}$
                        </div>
                        <div class="domino" data-n="3">
                            $\sqrt{abcd}$<br>=<br>$\sqrt{a}\sqrt{b}\sqrt{c}\sqrt{d}$
                        </div>
                        <div class="domino" data-n="4">
                            $\sqrt{abcde}$<br>=<br>$\sqrt{a}\sqrt{b}\sqrt{c}\sqrt{d}\sqrt{e}$
                        </div>
                        <div class="domino" data-n="5">
                            ⋯
                        </div>
                        <div class="domino" data-n="6">
                            ⋯
                        </div>
                    </div>
                    
                    <div id="multiplication-property" class="property-box">
                        <h5>How the Pattern Extends</h5>
                        <div class="property-step">
                            <strong>From 2 to 3 terms:</strong> $\sqrt{abc} = \sqrt{(ab) \cdot c} = \sqrt{ab} \cdot \sqrt{c} = \sqrt{a} \cdot \sqrt{b} \cdot \sqrt{c}$
                        </div>
                        <div class="property-step">
                            <strong>From 3 to 4 terms:</strong> $\sqrt{abcd} = \sqrt{(abc) \cdot d} = \sqrt{abc} \cdot \sqrt{d} = \sqrt{a} \cdot \sqrt{b} \cdot \sqrt{c} \cdot \sqrt{d}$
                        </div>
                        <div class="property-step">
                            <em>This pattern extends naturally because multiplication is associative!</em>
                        </div>
                    </div>
                </div>

                <div class="infinite-dominos" style="margin-top: 3rem;">
                    <h4>Addition Property: Testing the Pattern</h4>
                    <p>Click the first card to test if this equality actually holds:</p>
                    
                    <div class="card-chain" id="addition-cards">
                        <div class="card" data-n="1" onclick="animateAdditionCard(1)">
                            $\sqrt{a+b}$<br>=?<br>$\sqrt{a}+\sqrt{b}$
                        </div>
                        <div class="card" data-n="2">
                            $\sqrt{a+b+c}$<br>=?<br>$\sqrt{a}+\sqrt{b}+\sqrt{c}$
                        </div>
                        <div class="card" data-n="3">
                            $\sqrt{a+b+c+d}$<br>=?<br>$\sqrt{a}+\sqrt{b}+\sqrt{c}+\sqrt{d}$
                        </div>
                    </div>
                    
                    <div id="addition-property" class="property-box" style="display: none;">
                        <h5 style="color: var(--error-color);">Why This Fails</h5>
                        <div class="property-step" style="border-left-color: var(--error-color);">
                            <strong>Testing the claimed equality:</strong> $\sqrt{4+9} = \sqrt{13} \approx 3.6$ but $\sqrt{4} + \sqrt{9} = 2 + 3 = 5$ ✗
                        </div>
                        <div class="property-step" style="border-left-color: var(--error-color);">
                            <strong>The foundation is false!</strong> Since $\sqrt{a+b} \neq \sqrt{a} + \sqrt{b}$, the claimed pattern doesn't hold.
                        </div>
                    </div>
                </div>

                <div class="key-insights">
                    <h4>The Trap Revealed</h4>
                    <div class="insight-item">
                        <div class="insight-title">Natural Pattern Extension:</div>
                        <div>You naturally extend $\sqrt{ab} = \sqrt{a} \cdot \sqrt{b}$ to more terms. The same reasoning seems to apply to addition - "if the pattern works for n terms, it works for n+1 terms."</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-title">The Missing Foundation:</div>
                        <div>The inductive step alone isn't enough! You use your current assumption to prove the next case, so you must be absolutely certain about your starting point. Just one failed calculation breaks the entire infinite chain.</div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn" onclick="switchTab('formal')">Learn Formal Structure →</button>
                    <button class="nav-btn" onclick="switchTab('practice')">Try AI Practice →</button>
                </div>
            </div>
        </div>

        <div id="formal" class="tab-content">
            <div class="intro-section">
                <div class="concept-explanation">
                    <h3>The Two-Part Structure of Mathematical Induction</h3>
                    <p>Mathematical induction requires both components to work. Like our square root examples showed, the inductive step alone can mislead you into accepting false statements.</p>
                </div>

                <div class="formal-intro">
                    <h4>Mathematical Induction Framework</h4>
                    <p>To prove a statement P(n) for all integers n ≥ n₀:</p>
                    
                    <div class="induction-components">
                        <div class="component-box base-case">
                            <div class="component-title">Base Case</div>
                            <p>Prove P(n₀) is true</p>
                            <p><em>Verify the statement for the starting value</em></p>
                        </div>
                        
                        <div class="component-box inductive-step">
                            <div class="component-title">Inductive Step</div>
                            <p>Assume P(k) is true, then prove P(k+1) is true</p>
                            <p><em>Show: if the pattern holds for k, then it holds for k+1</em></p>
                        </div>
                    </div>
                    
                    <p><strong>Conclusion:</strong> P(n) is true for all integers n ≥ n₀</p>
                </div>

                <div class="example-toggle">
                    <button class="toggle-btn active" onclick="showExample('sum')" id="sum-toggle">Sum Formula Example</button>
                    <button class="toggle-btn" onclick="showExample('tree')" id="tree-toggle">Tree Coloring Example</button>
                </div>

                <div id="sum-example" class="example-card">
                    <h4>Proof: Sum of First n Odd Numbers</h4>
                    <p><strong>Statement:</strong> $1 + 3 + 5 + ... + (2n-1) = n^2$ for all positive integers n</p>
                    
                    <div class="proof-display">
                        <div class="proof-step base">
                            <strong>Base Case (n = 1):</strong><br>
                            Left side: 1<br>
                            Right side: $1^2 = 1$ ✓
                        </div>
                        
                        <div class="proof-step inductive">
                            <strong>Inductive Step:</strong><br>
                            Assume: $1 + 3 + 5 + ... + (2k-1) = k^2$<br>
                            Prove: $1 + 3 + 5 + ... + (2k-1) + (2(k+1)-1) = (k+1)^2$<br><br>
                            Left side = $k^2 + (2k+1)$ (by assumption)<br>
                            = $k^2 + 2k + 1 = (k+1)^2$ ✓
                        </div>
                        
                        <div class="proof-step">
                            <strong>Conclusion:</strong> The formula holds for all positive integers n
                        </div>
                    </div>
                </div>

                <div id="tree-example" class="example-card" style="display: none;">
                    <h4>Proof: Every Tree Can Be 2-Colored</h4>
                    <p><strong>Statement:</strong> Every tree with n vertices can be colored with just 2 colors so that adjacent vertices have different colors</p>
                    
                    <div class="tree-visual">
                        <div class="tree-diagram">
                            <div class="tree-title">1 vertex</div>
                            <svg class="tree-svg" viewBox="0 0 150 120">
                                <circle class="tree-vertex-small red" cx="75" cy="60" r="10"/>
                            </svg>
                        </div>
                        
                        <div class="tree-diagram">
                            <div class="tree-title">2 vertices</div>
                            <svg class="tree-svg" viewBox="0 0 150 120">
                                <line class="tree-edge" x1="55" y1="60" x2="95" y2="60"/>
                                <circle class="tree-vertex-small red" cx="55" cy="60" r="10"/>
                                <circle class="tree-vertex-small blue" cx="95" cy="60" r="10"/>
                            </svg>
                        </div>
                        
                        <div class="tree-diagram">
                            <div class="tree-title">3 vertices</div>
                            <svg class="tree-svg" viewBox="0 0 150 120">
                                <line class="tree-edge" x1="75" y1="40" x2="55" y2="80"/>
                                <line class="tree-edge" x1="75" y1="40" x2="95" y2="80"/>
                                <circle class="tree-vertex-small red" cx="75" cy="40" r="10"/>
                                <circle class="tree-vertex-small blue" cx="55" cy="80" r="10"/>
                                <circle class="tree-vertex-small blue" cx="95" cy="80" r="10"/>
                            </svg>
                        </div>
                        
                        <div class="tree-diagram">
                            <div class="tree-title">4 vertices</div>
                            <svg class="tree-svg" viewBox="0 0 150 120">
                                <line class="tree-edge" x1="75" y1="30" x2="75" y2="60"/>
                                <line class="tree-edge" x1="75" y1="60" x2="55" y2="90"/>
                                <line class="tree-edge" x1="75" y1="60" x2="95" y2="90"/>
                                <circle class="tree-vertex-small red" cx="75" cy="30" r="10"/>
                                <circle class="tree-vertex-small blue" cx="75" cy="60" r="10"/>
                                <circle class="tree-vertex-small red" cx="55" cy="90" r="10"/>
                                <circle class="tree-vertex-small red" cx="95" cy="90" r="10"/>
                            </svg>
                        </div>
                    </div>
                    
                    <div class="proof-display">
                        <div class="proof-step base">
                            <strong>Base Case (1 vertex):</strong><br>
                            A single vertex can be colored with one color (trivially 2-colorable) ✓
                        </div>
                        
                        <div class="proof-step inductive">
                            <strong>Inductive Step:</strong><br>
                            Assume: Any tree with k vertices can be 2-colored<br>
                            Prove: Any tree with k+1 vertices can be 2-colored<br><br>
                            Take any tree T with k+1 vertices. Find any vertex that is connected to exactly one other vertex.<br>
                            Remove this vertex - the remaining tree has k vertices, so by assumption it's 2-colorable.<br>
                            Color the removed vertex with the opposite color of its single neighbor ✓
                        </div>
                        
                        <div class="proof-step">
                            <strong>Conclusion:</strong> Every tree can be 2-colored
                        </div>
                    </div>
                </div>

                <div class="key-insights">
                    <h4>Why Both Parts Matter</h4>
                    <div class="insight-item">
                        <div class="insight-title">Base Case:</div>
                        <div>Ensures your pattern actually starts correctly. You use this foundation to prove the next case, so you must be absolutely certain about it. Many false statements have valid inductive steps but fail at this crucial starting point.</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-title">Inductive Step:</div>
                        <div>Ensures the pattern continues consistently. Shows that truth propagates from each case to the next.</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-title">Together:</div>
                        <div>They create an unbroken chain of truth from the base case to any finite case you want to reach.</div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn" onclick="switchTab('practice')">Practice with AI →</button>
                </div>
            </div>
        </div>

        <div id="practice" class="tab-content">
            <!-- MathPal Disclosure Banner -->
            <div style="background: var(--interactive-bg); border: 2px solid var(--primary-color); border-radius: 12px; padding: 1rem; margin: 2rem auto; max-width: 800px; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                <svg width="40" height="40" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="#e6fffb"/>
                    <rect x="35" y="60" width="30" height="25" fill="#0f766e" rx="3"/>
                    <rect x="30" y="35" width="40" height="30" fill="#10b981" rx="8"/>
                    <line x1="50" y1="35" x2="50" y2="25" stroke="#0f766e" stroke-width="2"/>
                    <circle cx="50" cy="23" r="3" fill="#f59e0b"/>
                    <circle cx="40" cy="47" r="5" fill="white"/>
                    <circle cx="60" cy="47" r="5" fill="white"/>
                    <circle cx="40" cy="47" r="3" fill="#0f766e" class="robot-eye"/>
                    <circle cx="60" cy="47" r="3" fill="#0f766e" class="robot-eye"/>
                    <path d="M 40 55 Q 50 60 60 55" stroke="#0f766e" stroke-width="2" fill="none"/>
                </svg>
                <div style="text-align: left;">
                    <div style="font-weight: 600; color: var(--primary-color); font-size: 1.1rem;">
                        MathPal - Your AI Study Buddy
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-muted);">
                        Learns alongside you • Can make mistakes • May be occasionally unavailable
                    </div>
                </div>
            </div>

            <div class="intro-section">
                <h2 style="text-align: center; color: var(--primary-color); margin-bottom: 1rem;">🤝 Practice with MathPal</h2>

                <div class="concept-explanation">
                    <p>Work through induction problems with MathPal as your study buddy. MathPal will give you hints and work alongside you, not teach from above.</p>
                </div>

                <!-- Problem Generation -->
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="generate-btn" onclick="generateMathPalProblem()">🎲 Generate New Problem</button>
                </div>

                <!-- Current Problem Display -->
                <div class="statement" id="mathpal-problem-statement" style="display: none; margin: 2rem 0;">
                    <!-- Problem will appear here -->
                </div>

                <!-- MathPal Workspace -->
                <div id="mathpal-workspace" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin: 2rem 0;">
                        <!-- Your Work Panel -->
                        <div style="background: white; border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem; min-height: 300px;">
                            <h3 style="color: var(--primary-color); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color);">📝 Your Work</h3>
                            
                            <!-- Base Case Input -->
                            <div>
                                <label style="font-weight: 600;">Find the Base Case:</label>
                                <input type="text" id="mathpal-base-input" style="width: 100%; padding: 0.75rem; font-size: 1rem; border: 2px solid var(--border-color); border-radius: 6px; margin: 0.5rem 0;" placeholder="e.g., n = 1 or n = 0">
                                <button class="generate-btn" onclick="checkMathPalBaseCase()" style="margin-top: 0.5rem;">
                                    ✓ Check Base Case
                                </button>
                            </div>
                            
                            <!-- Feedback Display -->
                            <div id="mathpal-base-feedback" class="feedback-display info" style="display: none; margin-top: 1rem;">
                                <!-- Feedback will appear here -->
                            </div>
                        </div>

                        <!-- MathPal's Panel -->
                        <div style="background: white; border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem; min-height: 300px;">
                            <h3 style="color: var(--primary-color); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color);">🤖 MathPal's Thinking</h3>
                            
                            <!-- Hint Buttons -->
                            <div style="display: flex; gap: 0.5rem; margin: 1rem 0; flex-wrap: wrap;">
                                <button style="padding: 0.5rem 1rem; background: white; border: 2px solid var(--primary-color); border-radius: 999px; color: var(--primary-color); cursor: pointer; font-size: 0.9rem;" onclick="getMathPalHint('nudge')">💭 Nudge</button>
                                <button style="padding: 0.5rem 1rem; background: white; border: 2px solid var(--primary-color); border-radius: 999px; color: var(--primary-color); cursor: pointer; font-size: 0.9rem;" onclick="getMathPalHint('observation')">🔍 Observation</button>
                                <button style="padding: 0.5rem 1rem; background: white; border: 2px solid var(--primary-color); border-radius: 999px; color: var(--primary-color); cursor: pointer; font-size: 0.9rem;" onclick="getMathPalHint('collaborate')">🤝 Collaborate</button>
                                <button style="padding: 0.5rem 1rem; background: white; border: 2px solid var(--primary-color); border-radius: 999px; color: var(--primary-color); cursor: pointer; font-size: 0.9rem;" onclick="getMathPalHint('reveal')">💡 Reveal</button>
                            </div>
                            
                            <!-- MathPal Response Area -->
                            <div id="mathpal-response" style="background: var(--interactive-bg); border-left: 3px solid var(--primary-color); padding: 1rem; border-radius: 6px; margin-top: 1rem; min-height: 80px;">
                                <div style="color: var(--text-muted); font-style: italic;">
                                    Click a hint button to get MathPal's help!
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Proof Construction Section -->
                    <div id="mathpal-proof-construction" class="proof-construction" style="display: none;">
                        <h5>Step 2: Build the Proof with MathPal</h5>
                        <div class="proof-structure">
                            <div class="proof-box">
                                <div class="box-label">Base Case (verified ✓)</div>
                                <div class="statement-display" id="mathpal-base-statement">
                                    <!-- Base case will be shown here -->
                                </div>
                            </div>
                            
                            <div class="proof-box if-then-container">
                                <div class="if-then-label">Inductive Step</div>
                                <div class="if-then-boxes">
                                    <div class="if-box">
                                        <div class="box-label">Assume P(k):</div>
                                        <div class="statement-display" id="mathpal-pk-statement">
                                            <!-- P(k) statement -->
                                        </div>
                                    </div>
                                    <div class="then-box">
                                        <div class="box-label">Prove P(k+1):</div>
                                        <div class="statement-display" id="mathpal-pk1-statement">
                                            <!-- P(k+1) statement -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="proof-box steps-container">
                                <div class="box-label">Arrange the proof steps in logical order:</div>
                                <div class="sortable-container" id="mathpal-proof-steps-container">
                                    <!-- Draggable proof steps will be added here -->
                                </div>
                                
                                <div class="proof-controls">
                                    <button class="proof-btn check" onclick="checkMathPalProofStructure()">✓ Check Proof</button>
                                    <button class="proof-btn reset" onclick="resetMathPalProofStructure()">↺ Shuffle Again</button>
                                    <button class="proof-btn hint" onclick="showMathPalProofHint()">💡 Hint</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Complete Proof Display -->
                    <div id="mathpal-complete-proof" class="complete-proof" style="display: none;">
                        <h5>✨ Complete Proof</h5>
                        <div id="mathpal-complete-proof-content" class="complete-proof-content">
                            <!-- Complete proof will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let state = {
            currentProblem: null,
            draggedElement: null,
            mathpalProblem: null,
            isWaitingForAI: false
        };

        // Fallback problems when AI is unavailable
        const fallbackProblems = {
            'sum-formula-basic': {
                statement: "For all integers $n \\ge 1$: $1 + 3 + 5 + ... + (2n-1) = n^2$",
                baseCase: "n = 1",
                baseValue: 1,
                hint: "For the inductive step, try to isolate the expression for P(k) on the left side of P(k+1).",
                baseCaseVerification: "For $n=1$, the statement is $1 = 1^2$, which is true.",
                p_k: "$1 + 3 + 5 + ... + (2k-1) = k^2$",
                p_k_plus_1: "$1 + 3 + 5 + ... + (2(k+1)-1) = (k+1)^2$",
                proofSteps: [
                    "Assume the statement is true for some integer $k \\ge 1$.",
                    "Consider the left-hand side (LHS) for $n=k+1$: $1 + 3 + ... + (2k-1) + (2(k+1)-1)$.",
                    "Using the inductive hypothesis, we can substitute $k^2$ for the sum up to $(2k-1)$.",
                    "The expression becomes $k^2 + (2(k+1)-1)$.",
                    "Simplifying this gives $k^2 + 2k + 1$.",
                    "This expression factors to $(k+1)^2$, which is the right-hand side (RHS) for $n=k+1$.",
                    "Thus, the statement holds for $n=k+1$.",
                    "By the principle of mathematical induction, the statement is true for all $n \\ge 1$. ∎"
                ]
            },
            'inequality-basic': {
                statement: "For all integers $n \\ge 1$: $2^n > n$",
                baseCase: "n = 1",
                baseValue: 1,
                hint: "After applying the inductive hypothesis, you'll have $2^{k+1} > 2k$. How can you show that $2k \\ge k+1$?",
                baseCaseVerification: "For $n=1$, the statement is $2^1 > 1$, or $2 > 1$, which is true.",
                p_k: "$2^k > k$",
                p_k_plus_1: "$2^{k+1} > k+1$",
                proofSteps: [
                    "Assume the statement is true for some integer $k \\ge 1$, so $2^k > k$.",
                    "Consider the case for $n=k+1$: we want to show $2^{k+1} > k+1$.",
                    "Start with the left-hand side: $2^{k+1} = 2 \\cdot 2^k$.",
                    "By the inductive hypothesis, since $2^k > k$, we have $2 \\cdot 2^k > 2k$.",
                    "For $k \\ge 1$, we know that $2k = k+k \\ge k+1$.",
                    "Combining these inequalities, we get $2^{k+1} > 2k \\ge k+1$.",
                    "Therefore, $2^{k+1} > k+1$.",
                    "By the principle of mathematical induction, the statement is true for all $n \\ge 1$. ∎"
                ]
            }
        };

        // MathPal problems for variety
        const mathpalProblems = [
            {
                statement: "For all integers $n \\ge 1$: $1 + 2 + 3 + ... + n = \\frac{n(n+1)}{2}$",
                baseValue: 1,
                baseCase: "n = 1",
                baseCaseVerification: "When $n = 1$: LHS = $1$, RHS = $\\frac{1(1+1)}{2} = \\frac{2}{2} = 1$. Since LHS = RHS, the base case holds.",
                p_k: "$1 + 2 + ... + k = \\frac{k(k+1)}{2}$",
                p_k_plus_1: "$1 + 2 + ... + k + (k+1) = \\frac{(k+1)(k+2)}{2}$",
                proofSteps: [
                    "Starting with the left side of P(k+1): $1 + 2 + ... + k + (k+1)$",
                    "By the inductive hypothesis, we can substitute: $\\frac{k(k+1)}{2} + (k+1)$",
                    "Factor out $(k+1)$: $(k+1)\\left(\\frac{k}{2} + 1\\right)$",
                    "Simplify inside the parentheses: $(k+1)\\left(\\frac{k+2}{2}\\right)$",
                    "This equals $\\frac{(k+1)(k+2)}{2}$, which is the right side of P(k+1).",
                    "Therefore, by mathematical induction, the formula holds for all $n \\ge 1$."
                ],
                hint: "Start by substituting the inductive hypothesis into the left side of P(k+1)."
            },
            {
                statement: "For all integers $n \\ge 0$: $2^0 + 2^1 + 2^2 + ... + 2^n = 2^{n+1} - 1$",
                baseValue: 0,
                baseCase: "n = 0",
                baseCaseVerification: "When $n = 0$: LHS = $2^0 = 1$, RHS = $2^{0+1} - 1 = 2 - 1 = 1$. Since LHS = RHS, the base case holds.",
                p_k: "$2^0 + 2^1 + ... + 2^k = 2^{k+1} - 1$",
                p_k_plus_1: "$2^0 + 2^1 + ... + 2^k + 2^{k+1} = 2^{k+2} - 1$",
                proofSteps: [
                    "Starting with the left side of P(k+1): $2^0 + 2^1 + ... + 2^k + 2^{k+1}$",
                    "By the inductive hypothesis: $(2^{k+1} - 1) + 2^{k+1}$",
                    "Combine like terms: $2 \\cdot 2^{k+1} - 1$",
                    "Simplify using exponent rules: $2^{k+2} - 1$",
                    "This is exactly the right side of P(k+1).",
                    "Therefore, by mathematical induction, the formula holds for all $n \\ge 0$."
                ],
                hint: "Remember that $2 \\cdot 2^{k+1} = 2^{k+2}$ by the laws of exponents."
            }
        ];

        // MathPal AI Integration
        async function callMathPalAI(prompt) {
            showMathPalThinking();
            
            const mathpalPrompt = `You are MathPal, a friendly peer study buddy (not a teacher).
Speak casually like a classmate: "I got...", "I tried...", "Want to see?", "Hmm, I think..."
${prompt}
Keep responses to 2-3 sentences, very conversational.
Use $ for inline LaTeX math. Reference the student's specific input when possible.
Never use teacher language like "correct" or "good job" - instead say things like "yeah, same here!" or "I got that too!"`;
            
            for (let attempt = 0; attempt <= 2; attempt++) {
                try {
                    if (attempt > 0) {
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    }
                    
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ 
                                role: "user", 
                                parts: [{ text: mathpalPrompt }] 
                            }] 
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) {
                        throw new Error('Empty response');
                    }
                    
                    hideMathPalThinking();
                    return text;
                    
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === 2) {
                        hideMathPalThinking();
                        return getMathPalFallback();
                    }
                }
            }
        }

        function showMathPalThinking() {
            state.isWaitingForAI = true;
            const responseDiv = document.getElementById('mathpal-response');
            if (responseDiv) {
                responseDiv.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 0.3rem; color: var(--text-muted); font-style: italic;">
                        MathPal is thinking
                        <span style="width: 6px; height: 6px; background: var(--primary-color); border-radius: 50%; animation: thinking 1.4s infinite ease-in-out;"></span>
                        <span style="width: 6px; height: 6px; background: var(--primary-color); border-radius: 50%; animation: thinking 1.4s infinite ease-in-out; animation-delay: 0.2s;"></span>
                        <span style="width: 6px; height: 6px; background: var(--primary-color); border-radius: 50%; animation: thinking 1.4s infinite ease-in-out; animation-delay: 0.4s;"></span>
                    </div>
                `;
            }
        }

        function hideMathPalThinking() {
            state.isWaitingForAI = false;
        }

        function getMathPalFallback() {
            const fallbacks = [
                "Hmm, I'm having trouble connecting right now. Want to work through this step by step together?",
                "My connection's a bit wonky. Let's figure this out together - what part are you stuck on?",
                "Can't seem to connect properly. But hey, we can still work on this! Where should we start?"
            ];
            return fallbacks[Math.floor(Math.random() * fallbacks.length)];
        }

        // MathPal specific functions
        function generateMathPalProblem() {
            const problemIndex = Math.floor(Math.random() * mathpalProblems.length);
            state.mathpalProblem = mathpalProblems[problemIndex];
            
            // Display problem
            document.getElementById('mathpal-problem-statement').style.display = 'block';
            document.getElementById('mathpal-problem-statement').innerHTML = `
                <strong>Prove by induction:</strong><br>
                ${state.mathpalProblem.statement}
            `;
            
            // Show workspace
            document.getElementById('mathpal-workspace').style.display = 'block';
            
            // Reset sections
            document.getElementById('mathpal-base-input').value = '';
            document.getElementById('mathpal-base-feedback').style.display = 'none';
            document.getElementById('mathpal-proof-construction').style.display = 'none';
            document.getElementById('mathpal-complete-proof').style.display = 'none';
            document.getElementById('mathpal-response').innerHTML = `
                <div style="color: var(--text-muted); font-style: italic;">
                    Click a hint button to get MathPal's help!
                </div>
            `;
            
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([document.getElementById('mathpal-problem-statement')]);
            }
        }

        async function checkMathPalBaseCase() {
            const userInput = document.getElementById('mathpal-base-input').value.toLowerCase().trim();
            const feedbackDiv = document.getElementById('mathpal-base-feedback');
            
            feedbackDiv.style.display = 'block';
            
            const correctValue = state.mathpalProblem.baseValue;
            const hasCorrectValue = userInput.includes(`${correctValue}`) || 
                                    userInput.includes(`n=${correctValue}`) ||
                                    userInput.includes(`n = ${correctValue}`) ||
                                    userInput.includes(`n= ${correctValue}`) ||
                                    userInput.includes(`n =${correctValue}`);
            
            if (hasCorrectValue) {
                feedbackDiv.className = 'feedback-display success';
                feedbackDiv.innerHTML = `
                    <strong>Correct!</strong><br>
                    Base case: ${state.mathpalProblem.baseCase}<br>
                    Now let's construct the complete proof!
                `;
                document.getElementById('mathpal-proof-construction').style.display = 'block';
                populateMathPalProofSteps();
                
                // Get MathPal's celebration
                const prompt = `The student correctly identified the base case as n = ${correctValue} for the induction proof.
                React like a peer who also got it right. Be encouraging about moving to the inductive step.`;
                const response = await callMathPalAI(prompt);
                document.getElementById('mathpal-response').innerHTML = `<div style="line-height: 1.6;">${response}</div>`;
                
            } else {
                feedbackDiv.className = 'feedback-display info';
                const userValue = parseInt(userInput.match(/-?\d+/)?.[0]);
                
                if (isNaN(userValue)) {
                    feedbackDiv.innerHTML = `
                        <strong>Hint:</strong><br>
                        Look for the smallest integer where the statement holds. Try n = 0, n = 1, etc.
                    `;
                } else if (userValue < correctValue) {
                    feedbackDiv.innerHTML = `
                        <strong>Too small!</strong><br>
                        The statement might not hold for n = ${userValue}. Try a larger value.
                    `;
                } else if (userValue > correctValue) {
                    feedbackDiv.innerHTML = `
                        <strong>Correct, but not the base case!</strong><br>
                        While the statement is true for n = ${userValue}, we need the smallest value.
                    `;
                }
            }
            
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([feedbackDiv]);
            }
        }

        async function getMathPalHint(level) {
            if (state.isWaitingForAI) return;
            if (!state.mathpalProblem) {
                alert('Please generate a problem first!');
                return;
            }
            
            const responseDiv = document.getElementById('mathpal-response');
            let prompt = '';
            
            switch(level) {
                case 'nudge':
                    prompt = `The student is working on proving: ${state.mathpalProblem.statement}
                    Give them a very gentle nudge about finding the base case - just a casual hint about where to start looking.
                    Don't give the answer, just point them in the right direction.`;
                    break;
                    
                case 'observation':
                    prompt = `The student is proving: ${state.mathpalProblem.statement}
                    The base case is n = ${state.mathpalProblem.baseValue}.
                    Make an observation about what makes this the right starting point, but don't solve it for them.
                    Talk about what to look for when finding base cases.`;
                    break;
                    
                case 'collaborate':
                    prompt = `The student is proving: ${state.mathpalProblem.statement}
                    The base case is n = ${state.mathpalProblem.baseValue}.
                    Work through checking if the formula holds for n = ${state.mathpalProblem.baseValue} together.
                    Show your work but let them finish the verification.`;
                    break;
                    
                case 'reveal':
                    prompt = `The student is proving: ${state.mathpalProblem.statement}
                    Share that the base case is n = ${state.mathpalProblem.baseValue} and show why:
                    ${state.mathpalProblem.baseCaseVerification}
                    Be encouraging about moving on to the inductive step.`;
                    break;
            }
            
            const response = await callMathPalAI(prompt);
            responseDiv.innerHTML = `<div style="line-height: 1.6;">${response}</div>`;
            
            // Render any LaTeX in the response
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([responseDiv]);
            }
        }

        function populateMathPalProofSteps() {
            if (!state.mathpalProblem) return;

            document.getElementById('mathpal-base-statement').innerHTML = state.mathpalProblem.baseCaseVerification;
            document.getElementById('mathpal-pk-statement').innerHTML = state.mathpalProblem.p_k;
            document.getElementById('mathpal-pk1-statement').innerHTML = state.mathpalProblem.p_k_plus_1;

            const container = document.getElementById('mathpal-proof-steps-container');
            container.innerHTML = '';

            const proofStepItems = state.mathpalProblem.proofSteps.map((step, index) => {
                return { content: step, order: index };
            });

            const shuffledSteps = [...proofStepItems].sort(() => Math.random() - 0.5);

            shuffledSteps.forEach((item, index) => {
                const stepEl = document.createElement('div');
                stepEl.className = 'proof-step-item';
                stepEl.draggable = true;
                stepEl.innerHTML = item.content;
                stepEl.setAttribute('data-order', item.order);
                stepEl.setAttribute('data-id', `mathpal-step-${index}`);
                container.appendChild(stepEl);
            });
            
            setupMathPalSortable();
            
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([document.getElementById('mathpal-proof-construction')]);
            }
        }

        function setupMathPalSortable() {
            const container = document.getElementById('mathpal-proof-steps-container');
            
            container.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('proof-step-item')) {
                    state.draggedElement = e.target;
                    e.target.classList.add('dragging');
                }
            });
            
            container.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('proof-step-item')) {
                    e.target.classList.remove('dragging');
                }
            });
            
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                
                if (afterElement == null) {
                    container.appendChild(state.draggedElement);
                } else {
                    container.insertBefore(state.draggedElement, afterElement);
                }
            });
        }

        async function checkMathPalProofStructure() {
            const container = document.getElementById('mathpal-proof-steps-container');
            const steps = container.querySelectorAll('.proof-step-item');
            
            let isCorrect = true;
            steps.forEach((step, index) => {
                const expectedOrder = parseInt(step.getAttribute('data-order'));
                if (expectedOrder !== index) {
                    isCorrect = false;
                    step.classList.remove('correct-position');
                } else {
                    step.classList.add('correct-position');
                }
            });
            
            if (isCorrect) {
                showMathPalCompleteProof();
                
                // Get MathPal's congratulations
                const prompt = `The student successfully completed the induction proof! 
                React like a peer who also just finished the same proof. Be excited but casual.`;
                const response = await callMathPalAI(prompt);
                document.getElementById('mathpal-response').innerHTML = `<div style="line-height: 1.6;">${response}</div>`;
                
            } else {
                alert('Not quite right! Check the logical flow. Correctly placed steps are highlighted in green.');
            }
        }

        function showMathPalCompleteProof() {
            const completeProof = document.getElementById('mathpal-complete-proof');
            const content = document.getElementById('mathpal-complete-proof-content');
            
            const { statement, baseValue, baseCaseVerification, p_k, p_k_plus_1, proofSteps } = state.mathpalProblem;
            const proofParagraphs = proofSteps.map(step => `<p>${step}</p>`).join('');

            content.innerHTML = `
                <p><strong>Proof by Mathematical Induction:</strong></p>
                <p>We will prove that ${statement.replace(/For all integers.*?:/, '').trim()}.</p>
                
                <strong>Base Case (n = ${baseValue}):</strong>
                <p>${baseCaseVerification}</p>
                
                <strong>Inductive Step:</strong>
                <p>Assume the statement holds for some integer $k \\ge ${baseValue}$. That is, we assume:</p>
                <p style="text-align:center;">${p_k}</p>
                <p>We must now show that the statement holds for $n = k+1$. That is, we must prove:</p>
                <p style="text-align:center;">${p_k_plus_1}</p>
                
                ${proofParagraphs}
                
                <div style="text-align: right; font-size: 1.2rem; font-weight: bold; color: var(--primary-color); margin-top: 1rem;">∎</div>
            `;
            
            completeProof.style.display = 'block';
            completeProof.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([content]);
            }
        }

        function resetMathPalProofStructure() {
            populateMathPalProofSteps();
        }

        async function showMathPalProofHint() {
            if (!state.mathpalProblem) {
                alert('Please generate a problem first!');
                return;
            }
            
            const hints = [
                "The proof should always begin by stating the assumption (the inductive hypothesis).",
                "After the assumption, clearly state what you intend to prove for the k+1 case.",
                "Start with the more complex side of the P(k+1) equation and try to simplify it.",
                "Look for a way to use the P(k) assumption. You almost always substitute it into the P(k+1) expression.",
                "The next steps usually involve algebraic simplification.",
                "Keep manipulating the expression until it matches the other side of the P(k+1) equation.",
                "Your second to last step should explicitly show that the LHS equals the RHS of P(k+1).",
                "The final step is always the concluding sentence based on the principle of induction."
            ];
            
            const container = document.getElementById('mathpal-proof-steps-container');
            const steps = container.querySelectorAll('.proof-step-item');
            let firstWrong = -1;
            
            steps.forEach((step, index) => {
                const expectedOrder = parseInt(step.getAttribute('data-order'));
                if (expectedOrder !== index && firstWrong === -1) {
                    firstWrong = index;
                }
            });
            
            if (firstWrong >= 0 && firstWrong < hints.length) {
                alert(hints[firstWrong]);
                
                // Also get MathPal's hint about the proof structure
                const prompt = `The student is arranging proof steps for an induction proof.
                They need help with step ${firstWrong + 1}. Give a casual hint about: "${hints[firstWrong]}"
                Don't give the full answer, just a friendly pointer.`;
                const response = await callMathPalAI(prompt);
                document.getElementById('mathpal-response').innerHTML = `<div style="line-height: 1.6;">${response}</div>`;
                
            } else {
                alert(`Remember: ${state.mathpalProblem.hint}`);
            }
        }


        // DOM references
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Initialize
        function init() {
            setupTabs();
            
            // Typeset initial math
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise();
            }
        }

        // Tab switching
        function setupTabs() {
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }

        function switchTab(tabId) {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // Show domino falling animation - always starts from first domino
        function animateDominos() {
            const chain = document.getElementById('multiplication-dominos');
            
            // Reset all dominos
            chain.querySelectorAll('.domino').forEach(d => {
                d.classList.remove('falling');
            });
            
            // Make all dominos fall one after another starting from the first
            for (let i = 1; i <= 6; i++) {
                const domino = chain.querySelector(`[data-n="${i}"]`);
                if (domino) {
                    setTimeout(() => {
                        domino.classList.add('falling');
                    }, (i - 1) * 150);
                }
            }
            
            // Typeset math
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise();
            }
        }

        // Show addition card turning red
        function animateAdditionCard(n) {
            const chain = document.getElementById('addition-cards');
            const propertyBox = document.getElementById('addition-property');
            
            if (n === 1) {
                const card = chain.querySelector(`[data-n="1"]`);
                card.classList.add('error');
                propertyBox.style.display = 'block';
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([propertyBox]);
                }
            }
        }

        // Example toggle in formal tab
        function showExample(type) {
            const sumBtn = document.getElementById('sum-toggle');
            const treeBtn = document.getElementById('tree-toggle');
            const sumExample = document.getElementById('sum-example');
            const treeExample = document.getElementById('tree-example');
            
            if (type === 'sum') {
                sumBtn.classList.add('active');
                treeBtn.classList.remove('active');
                sumExample.style.display = 'block';
                treeExample.style.display = 'none';
            } else {
                treeBtn.classList.add('active');
                sumBtn.classList.remove('active');
                treeExample.style.display = 'block';
                sumExample.style.display = 'none';
            }
            
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([document.querySelector('#formal .intro-section')]);
            }
        }

        // Fixed AI integration - matching the working if-then app structure
        async function callAI(prompt, retries = 2) {
            for (let i = 0; i <= retries; i++) {
                try {
                    if (i > 0) {
                        await new Promise(r => setTimeout(r, Math.pow(2, i-1) * 1000));
                    }
                    
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ role: "user", parts: [{ text: prompt }] }] 
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) {
                        throw new Error('Empty response from AI');
                    }
                    
                    return text;
                    
                } catch (error) {
                    console.error(`AI attempt ${i+1} failed:`, error);
                    if (i === retries) {
                        throw error;
                    }
                }
            }
        }

        function extractJSON(text) {
            let data;
            
            try {
                data = JSON.parse(text);
            } catch {
                // Try to find JSON in the response
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('No JSON found in response');
                }
                
                const cleaned = jsonMatch[0]
                    .replace(/```json\s*/g, '')
                    .replace(/```\s*/g, '')
                    .trim();
                
                try {
                    data = JSON.parse(cleaned);
                } catch (e) {
                    throw new Error('Invalid JSON format');
                }
            }
            
            // Validate required fields
            const required = ['statement', 'baseCase', 'baseValue', 'baseCaseVerification', 'p_k', 'p_k_plus_1', 'proofSteps'];
            for (const field of required) {
                if (!(field in data)) {
                    throw new Error(`Missing required field: ${field}`);
                }
            }
            
            // Ensure proofSteps is an array
            if (!Array.isArray(data.proofSteps)) {
                throw new Error('proofSteps must be an array');
            }
            
            return data;
        }

        async function generateProblem() {
            const statementType = document.getElementById('statement-type').value;
            const difficulty = document.getElementById('difficulty').value;
            const generateBtn = document.getElementById('generate-problem');
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            
            document.getElementById('current-problem').style.display = 'block';
            document.getElementById('statement-display').innerHTML = 'Generating a new induction problem...';
            
            // Clear any old warnings
            document.querySelectorAll('.warning-notice').forEach(n => n.remove());
            
            const prompt = `
                Generate a mathematical induction problem.
                - Type: ${statementType}
                - Difficulty: ${difficulty}

                Return ONLY a single valid JSON object with the following structure:
                {
                  "statement": "The full statement to be proven, using LaTeX, like 'For all integers $n \\ge 1$: ...'",
                  "baseCase": "A short string for the base case, like 'n = 1'",
                  "baseValue": 1,
                  "hint": "A short, helpful hint for the proof.",
                  "baseCaseVerification": "A single sentence that shows the base case is true, using LaTeX. Example: 'For $n=1$, the statement is $2^1 > 1$, which is true.'",
                  "p_k": "The mathematical expression for P(k), using LaTeX. Example: '$2^k > k$'.",
                  "p_k_plus_1": "The mathematical expression for P(k+1), using LaTeX. Example: '$2^{k+1} > k+1$'.",
                  "proofSteps": [
                    "An array of strings, where each string is a single sentence in the logical flow of the inductive step proof.",
                    "The proof should start with the assumption and end with the conclusion.",
                    "Use LaTeX for all math.",
                    "Example Step: 'By the inductive hypothesis, we can substitute $k^2$ for the grouped sum.'"
                  ]
                }
                
                IMPORTANT: Return ONLY the JSON object, no markdown formatting, no explanations.
            `;
            
            try {
                const response = await callAI(prompt, 2);
                state.currentProblem = extractJSON(response);
                
                document.getElementById('statement-display').innerHTML = state.currentProblem.statement;
                document.getElementById('base-case-input').value = '';
                document.getElementById('base-case-feedback').style.display = 'none';
                document.getElementById('proof-construction').style.display = 'none';
                
            } catch (error) {
                console.error('AI generation failed:', error);
                
                const fallbackKey = `${statementType}-basic`; // Simplified fallback key
                state.currentProblem = fallbackProblems[fallbackKey] || fallbackProblems['sum-formula-basic'];
                
                document.getElementById('statement-display').innerHTML = state.currentProblem.statement;
                
                // Show warning notice
                const warning = document.createElement('div');
                warning.className = 'warning-notice';
                warning.innerHTML = '⚠️ Using backup problem (AI temporarily unavailable)';
                const problemContainer = document.getElementById('current-problem');
                problemContainer.insertBefore(warning, problemContainer.firstChild);

                setTimeout(() => { if (warning) warning.remove(); }, 5000);
            }
            
            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate Problem with AI';
            
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([document.getElementById('statement-display')]);
            }
        }

        function checkBaseCase() {
            if (!state.currentProblem) {
                alert('Please generate a problem first!');
                return;
            }
            
            const userInput = document.getElementById('base-case-input').value.trim().toLowerCase();
            const correctValue = state.currentProblem.baseValue;
            const feedbackDiv = document.getElementById('base-case-feedback');
            
            feedbackDiv.style.display = 'block';
            
            const hasCorrectValue = userInput.includes(correctValue.toString()) || 
                                    userInput.includes(`n = ${correctValue}`) || 
                                    userInput.includes(`n=${correctValue}`);
            
            if (hasCorrectValue) {
                feedbackDiv.className = 'feedback-display success';
                feedbackDiv.innerHTML = `
                    <strong>Correct!</strong><br>
                    Base case: ${state.currentProblem.baseCase}<br>
                    Now let's construct the complete proof!
                `;
                document.getElementById('proof-construction').style.display = 'block';
                populateProofSteps();
            } else {
                feedbackDiv.className = 'feedback-display info';
                const userValue = parseInt(userInput.match(/-?\d+/)?.[0]);
                
                if (isNaN(userValue)) {
                    feedbackDiv.innerHTML = `
                        <strong>Hint:</strong><br>
                        Look for the smallest integer where the statement holds. Try n = 0, n = 1, etc.
                    `;
                } else if (userValue < correctValue) {
                    feedbackDiv.innerHTML = `
                        <strong>Too small!</strong><br>
                        The statement might not hold for n = ${userValue}. Try a larger value.
                    `;
                } else if (userValue > correctValue) {
                    feedbackDiv.innerHTML = `
                        <strong>Correct, but not the base case!</strong><br>
                        While the statement is true for n = ${userValue}, we need the smallest value.
                    `;
                }
            }
        }

        function populateProofSteps() {
            if (!state.currentProblem) return;

            document.getElementById('base-statement').innerHTML = state.currentProblem.baseCaseVerification;
            document.getElementById('pk-statement').innerHTML = state.currentProblem.p_k;
            document.getElementById('pk1-statement').innerHTML = state.currentProblem.p_k_plus_1;

            const container = document.getElementById('proof-steps-container');
            container.innerHTML = '';

            const proofStepItems = state.currentProblem.proofSteps.map((step, index) => {
                return { content: step, order: index };
            });

            const shuffledSteps = [...proofStepItems].sort(() => Math.random() - 0.5);

            shuffledSteps.forEach((item, index) => {
                const stepEl = document.createElement('div');
                stepEl.className = 'proof-step-item';
                stepEl.draggable = true;
                stepEl.innerHTML = item.content;
                stepEl.setAttribute('data-order', item.order);
                stepEl.setAttribute('data-id', `step-${index}`);
                container.appendChild(stepEl);
            });
            
            document.getElementById('complete-proof').style.display = 'none';
            setupSortable();
            
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([document.getElementById('proof-construction')]);
            }
        }

        function setupSortable() {
            const container = document.getElementById('proof-steps-container');
            
            container.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('proof-step-item')) {
                    state.draggedElement = e.target;
                    e.target.classList.add('dragging');
                }
            });
            
            container.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('proof-step-item')) {
                    e.target.classList.remove('dragging');
                }
            });
            
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                
                if (afterElement == null) {
                    container.appendChild(state.draggedElement);
                } else {
                    container.insertBefore(state.draggedElement, afterElement);
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.proof-step-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function checkProofStructure() {
            const container = document.getElementById('proof-steps-container');
            const steps = container.querySelectorAll('.proof-step-item');
            
            let isCorrect = true;
            steps.forEach((step, index) => {
                const expectedOrder = parseInt(step.getAttribute('data-order'));
                if (expectedOrder !== index) {
                    isCorrect = false;
                    step.classList.remove('correct-position');
                } else {
                    step.classList.add('correct-position');
                }
            });
            
            if (isCorrect) {
                showCompleteProof();
            } else {
                alert('Not quite right! Check the logical flow. Correctly placed steps are highlighted in green.');
            }
        }

        function showCompleteProof() {
            const completeProof = document.getElementById('complete-proof');
            const content = document.getElementById('complete-proof-content');
            
            document.querySelectorAll('.proof-box').forEach(box => {
                box.style.transition = 'opacity 0.5s, transform 0.5s';
                box.style.opacity = '0.3';
                box.style.transform = 'scale(0.98)';
            });
            
            const { statement, baseValue, baseCaseVerification, p_k, p_k_plus_1, proofSteps } = state.currentProblem;
            const proofParagraphs = proofSteps.map(step => `<p>${step}</p>`).join('');

            content.innerHTML = `
                <p><strong>Proof by Mathematical Induction:</strong></p>
                <p>We will prove that ${statement.replace(/For all integers.*?:/, '').trim()}.</p>
                
                <strong>Base Case (n = ${baseValue}):</strong>
                <p>${baseCaseVerification}</p>
                
                <strong>Inductive Step:</strong>
                <p>Assume the statement holds for some integer $k \\ge ${baseValue}. That is, we assume:</p>
                <p style="text-align:center;">${p_k}</p>
                <p>We must now show that the statement holds for $n = k+1$. That is, we must prove:</p>
                <p style="text-align:center;">${p_k_plus_1}</p>
                
                ${proofParagraphs}
                
                <div class="qed">∎</div>
            `;
            
            completeProof.style.display = 'block';
            completeProof.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([content]);
            }
        }

        function resetProofStructure() {
            document.querySelectorAll('.proof-box').forEach(box => {
                box.style.opacity = '1';
                box.style.transform = 'scale(1)';
            });
            
            populateProofSteps();
        }

        function showProofHint() {
            if (!state.currentProblem) {
                alert('Please generate a problem first!');
                return;
            }
            
            const hints = [
                "The proof should always begin by stating the assumption (the inductive hypothesis).",
                "After the assumption, clearly state what you intend to prove for the k+1 case.",
                "Start with the more complex side of the P(k+1) equation and try to simplify it.",
                "Look for a way to use the P(k) assumption. You almost always substitute it into the P(k+1) expression.",
                "The next steps usually involve algebraic simplification.",
                "Keep manipulating the expression until it matches the other side of the P(k+1) equation.",
                "Your second to last step should explicitly show that the LHS equals the RHS of P(k+1).",
                "The final step is always the concluding sentence based on the principle of induction."
            ];
            
            const container = document.getElementById('proof-steps-container');
            const steps = container.querySelectorAll('.proof-step-item');
            let firstWrong = -1;
            
            steps.forEach((step, index) => {
                const expectedOrder = parseInt(step.getAttribute('data-order'));
                if (expectedOrder !== index && firstWrong === -1) {
                    firstWrong = index;
                }
            });
            
            if (firstWrong >= 0 && firstWrong < hints.length) {
                alert(hints[firstWrong]);
            } else {
                alert(`Remember: ${state.currentProblem.hint}`);
            }
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
